<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>
	<?include Includes.wxi?>
	<Product id="$(var.ProductGuid)"
			Name='!(loc.AppName) $(var.CurrentBerViewerVersion)'
			Language='1033'
			Version='$(var.CurrentBerViewerVersion)'
			Manufacturer='!(loc.Manufacturer)'
			UpgradeCode="$(var.CurrentUpdateGuid)" >

		<!-- We set InstallScope to perMachine to install for all users -->
		<Package Description='!(loc.PackageDescription)' Comments='!(loc.PackageComments)'
				Manufacturer='!(loc.Manufacturer)'
				InstallerVersion='200'
				InstallPrivileges='elevated' InstallScope='perMachine'
				Compressed='yes' />

		<!-- http://wixtoolset.org/documentation/manual/v3/howtos/ui_and_localization/configure_arp_appearance.html -->
		<Icon Id="icon.ico" SourceFile="berviewer.ico"/>
		<Property Id="ARPPRODUCTICON" value="icon.ico" />

		<!-- Don't allow downgrade. -->
		<MajorUpgrade DowngradeErrorMessage='!(loc.DowngradeErrorMessage)' />

		<Property Id="SUPPRESS_LAUNCH_BERVIEWER_AFTER_INSTALL_FINISH">
			<RegistrySearch Id="SuppressLaunchBerViewerHKCU"
							Root="HKCU"
							Key="SOFTWARE\!(loc.AppName)"
							Name="PreconfigureSuppressLaunchAfterInstall"
							Type="raw" />

			<RegistrySearch Id="SuppressLaunchBerViewerHKLM"
							Root="HKLM"
							Key="SOFTWARE\!(loc.AppName)"
							Name="PreconfigureSuppressLaunchAfterInstall"
							Type="raw" />
		</Property>

		<Media Id='1' Cabinet='berviewer.cab' EmbedCab='yes' />
		<Property Id="BERVIEWER_AUTO_START">1</Property>

		<!-- Auto-start via REgistry -->
		<DirectoryRef Id="INSTALLDIR">
			<Component Id="BerViewerAutoStart" Guid="$(var.GuidOfAutoStartComponent)">
				<RegistryKey Root="HKCU"
							Key="Software\Microsoft\Windows\CurrentVersion\Run"
							Action="create">
					<RegistryValue Name='!(loc.AppName)' Value="[#berviewer.exe]" Type="string" KeyPath="yes" />
				</RegistryKey>

				<Condition>BERVIEWER_AUTO_START</Condition>
			</Component>
		</DirectoryRef>

		<DirectoryRef Id="BerViewerStartMenuFolder">
			<Component Id="BerViewer_StartMenuShortCut" Guid="$(var.GuidOfStartMenuShortCutComponent)" >
				<RemoveFolder Id="BerViewerStartMenuFolder" On="uninstall" />
				<RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]"
						Name="Installed" Type="integer" Value="1" KeyPath='yes' />

				<!-- shortcut to 'start berviewer' -->
				<Shortcut Id="ApplicationStartMenuShortCut" Directory="BerViewerStartMenuFolder"
							Name="!(loc.StartBerViewer)" Target="[#berviewer.exe]"
							HotKey="0" IconIndex="0" Show="normal"
							WorkingDirectory="bin" />

				<!-- shortcut to 'Uninstall' -->
				<Shortcut Id="UninstallProduct" name="!(loc.UninstallBerViewer)"
							Target="[SystemFolder]msiexec.exe" IconIndex="0"
							Arguments="/x [ProductCode]" Description="!(loc.UninstallBerViewer)" />
			</Component>
		<DirectoryRef>

		<!-- UI related -->
		<Property Id='WIXUI_INSTALLDIR' Value="INSTALLDIR" />
		<UI>
			<UIRef Id='WixUI_InstallDir_NoLicense' />
			<UIRef Id='WixUI_ErrorProgressText' />
			<Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchApplication">
				<!-- Launch BerViewer after setup. -->
				(NOT Installed) AND (NOT SUPPRESS_LAUNCH_BERVIEWER_AFTER_INSTALL_FINISH)
			</Publish>
		</UI>

		<Property Id="WixShellExecTarget" Value="[#berviewer.exe]" />
		<CustomAction Id="LaunchApplication" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes" />

		<Feature Id='Main' Level='1'>
			<ComponentRef Id='BerViewer_StartMenuShortCut' />
			<ComponentRef Id='BerViewerAutoStart' />
			<!-- defined in fragment.wxs -->
			<ComponentGroupRef Id='group_bin' />
		</Feature>

		<Property Id="CHECKBOX_DEL_BERVIEWER_DATA" Secure="yes" />
		<WixVariable Id="WixUIBannerBmp" Value="berviewer-top-banner.bmp" />
		<WixVariable Id="WixUIDialogBmp" Value="berviewer-background.bmp" />

	</Product>
</Wix>
